# Dedex

Dedex is a DDEX XML file parser. DDEX is a standard used in the music industry to deliver rich media content. See more info at [ddex.net](https://ddex.net/). This covers only the ERN (Electronic Release Notification) standard, for versions 3.8.2 and 4.1.

In my past experiences as a developer, I always had to develop or enhanced a DDEX parser for ERN. I created one here that is as convenient to use as I always hoped for.

The **Rule** mechanism is pretty useful and flexible. The DDEX ERN standard is extremely vast and there are many ways to use it. Most providers generate a simplified yet comprehensive XML file covering most of the needs. The Rules helps checking during the parsing that not only the XML is valid, but contain the minimal consistent information.

It is possible to implement your own rules (contribute to this repository if you think other developers could make a use of it), and to implement a different set of rules for different provider.

For instance, it is possible to enforce that for a given XML the ISRC is provided for all recordings, but not for another one. Providers rules can be modelled in a **Rules Set**.

If you find this useful, please star this repository, and contribute.

## Usage

### Parse a file without XSD validation

```php
use DedexBundle\Controller\ErnParserController;

$xml_path = "tests/samples/001_audioalbum_complete.xml";
$parser = new ErnParserController();
$ern = $parser->parse($xml_path);
```

### Parse a file with XSD validation

XSD validation will load all XML and XSD in memory, making this library less efficient. Use with care. Is not adapted to gigantic files.

```php
use DedexBundle\Controller\ErnParserController;

$xml_path = "tests/samples/001_audioalbum_complete.xml";
$parser = new ErnParserController();
$parser->setXsdValidation(true);
$ern = $parser->parse($xml_path);
```

### Parse a file with a Rule

```php
use DedexBundle\Controller\ErnParserController;
use DedexBundle\Rule\AtLeastOneImage;
use DedexBundle\Exception\RuleValidationException;

$xml_path = "tests/samples/001_audioalbum_complete.xml";
$parser = new ErnParserController();
$parser->addRule(new AtLeastOneImage(Rule::LEVEL_ERROR));
// ... can add multiple rules
$ern = $parser->parse($xml_path);  // will raise an RuleValidationException if rule is broken
```

## Parser config

Here are handy function from the parser.

`$parser=new ErnParserController();`

```php
$parser->setDisplayLog(true);
```

Displays parsing logs. For debugging purpose mainly. (default: `false`)

```php
$parser->setXsdValidation(true);
``` 

Validates XML against XSD. (default: `false` because will load XSD and XML in memory)

```php
$parser->getRuleMessages();
```

Returns a formatted string (with new lines) of all the errors generated by the rule checking. To be called when parsing ended. 
If one of the `ERROR` rules fail, the parser will throw an exception with these messages. 
In the case of only `WARNING` raised during the parsing, this function is the only way to read them. 


## Contribute

If you want to contribute, here are some elements to start with.

### Setup a dev environment with Docker

Generate an image with the provided `Dockerfile`: 

```
docker build -t dedex-img .
```

And run it with:
```
docker run \
  --name=dedex \
  --network=host \
  -v /home/mickael/dev/dedex/dedex:/home/mickael/dev/dedex/dedex \
  -v /home/mickael/dev/dedex/xdebug.ini:/usr/local/etc/php/conf.d/xdebug.ini
  -ti dedex-img \
  bash
```

### Running Tests

In the docker, run the phpunit test command:

```
./bin/phpunit
```

### Generating Documentation

Run the phpDocumentator command:

```
php phpDocumentor.phar -d src -t docs
```

### Generating DDEX classes

I used the superb `xsd2php` package to generate classes based on the XSD provided by DDEX.

The parser is "filling" these objects while parsing the XML file line by line.

```
vendor/bin/xsd2php convert config.yml /home/my/ota/OTA_Air*.xsd
```